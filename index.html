<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPA Calculator — 8 Semesters</title>
  <style>
    :root{
      --bg: #f6f8fa;
      --card: #fff;
      --accent: #0053ba;
      --accent-hover: #003599;
      --muted: #666;
      --badge-bg: #e9f2ff;
      --badge-border: #cfe3ff;
    }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg);
      margin: 0;
      padding: 18px;
      color: #222;
    }

    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .titleBlock { display:flex; flex-direction:column; gap:6px; min-width:0; }
    h1 { font-size:1.2rem; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .subtitle { color:var(--muted); font-size:0.95rem; margin:0; }

    /* Prominent cumulative GPA in header */
    .cumulativeHeader {
      background: linear-gradient(90deg, rgba(0,83,186,0.08), rgba(0,83,186,0.04));
      border: 1px solid rgba(0,83,186,0.08);
      padding: 10px 14px;
      border-radius: 10px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      min-width:160px;
    }
    .cumulativeHeader .label { font-size:0.85rem; color:var(--muted); }
    .cumulativeHeader .value { font-size:1.35rem; font-weight:800; color:var(--accent); }

    .controls { display:flex; gap:8px; align-items:center; margin-left:8px; flex-wrap:wrap; }
    .controls .small { padding:6px 10px; border-radius:8px; font-size:0.9rem; background:var(--accent); color:#fff; border:none; cursor:pointer; }
    .controls .small[disabled]{ opacity:0.5; cursor:not-allowed; }

    /* Grid layout */
    .container {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(4, 1fr);
      align-items: start;
    }

    .semester {
      background: var(--card);
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      padding: 12px;
      display: flex;
      flex-direction: column;
      min-height: 180px;
      transition: opacity .18s linear;
      position: relative;
    }

    .semester.disabled { opacity: 0.55; }

    .semester-title {
      font-weight: 600;
      margin-bottom: 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .badge {
      background: var(--badge-bg);
      border: 1px solid var(--badge-border);
      color: var(--muted);
      font-size: 0.78rem;
      padding: 4px 8px;
      border-radius: 999px;
      white-space:nowrap;
    }

    .courses { margin-bottom: 8px; display:flex; flex-direction:column; gap:8px; }

    .course { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    label { font-size:0.9rem; color: #111; display:flex; align-items:center; gap:6px; }
    select { padding:6px 8px; border-radius:6px; border:1px solid #e6e6e6; background:white; font-size:0.95rem; }
    button { cursor:pointer; border: none; border-radius:6px; padding:6px 10px; background:var(--accent); color:white; }
    button[disabled]{ opacity:0.5; cursor:not-allowed; }
    .small { padding:4px 8px; font-size:0.9rem; }

    .gpa-row { margin-top:auto; border-top:1px solid #eee; padding-top:8px; font-weight:600; text-align:center; }

    /* Disabled overlay: covers the body of the semester (not the header) */
    .disabledOverlay {
      position: absolute;
      left: 0;
      right: 0;
      /* leave space for header/title (approx 44px) so the Enable checkbox remains clickable */
      top: 44px;
      bottom: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.6));
      pointer-events: auto; /* block interactions with inner controls */
      border-radius: 0 0 8px 8px;
    }
    .disabledOverlayContent {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      color:var(--muted);
      font-size:0.95rem;
    }
    .disabledIcon {
      width:44px;
      height:44px;
      display:inline-block;
      border-radius:999px;
      background: rgba(0,0,0,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .disabledIcon svg { width:22px; height:22px; fill: rgba(0,0,0,0.5); }

    /* Floating, movable cumulative GPA */
    #floatGPA {
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      padding: 10px 12px;
      min-width: 120px;
      text-align: center;
      touch-action: none;
      display: none; /* hidden by default; shown only when header not visible */
    }
    #floatGPA .label { font-size: 0.78rem; color: var(--muted); margin-bottom:4px; }
    #floatGPA .value { font-weight:800; color:var(--accent); font-size:1.1rem; }
    .floatHint { font-size:0.72rem; color:var(--muted); margin-top:6px; }

    /* Responsive: 3/2/1 columns */
    @media (max-width:1200px) { .container { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width:900px)  { .container { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width:540px)  { .container { grid-template-columns: 1fr; } .semester { min-height: auto; } header { align-items:flex-start; } }

  </style>
</head>
<body>
  <header>
    <div class="titleBlock">
      <h1>GPA Calculator</h1>
      <p class="subtitle">You can disable a semester (3–8) and all following ones. Semesters 1–2 remain fixed.</p>
    </div>

    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
      <div class="controls" aria-hidden="false">
        <button id="resetBtn" class="small">Reset to defaults</button>
        <button id="exportBtn" class="small">Export JSON</button>
        <button id="importBtn" class="small">Import JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </div>

      <div class="cumulativeHeader" aria-live="polite" id="cumulativeHeader">
        <div class="label">Cumulative GPA</div>
        <div class="value" id="cumulativeGPA">0.00</div>
      </div>
    </div>
  </header>

  <main>
    <div class="container" id="semesters"></div>
  </main>

  <!-- Floating, movable cumulative GPA for mobile/scroll -->
  <div id="floatGPA" role="status" aria-live="polite" title="Drag to move">
    <div class="label">Cumulative GPA</div>
    <div class="value" id="floatCumulativeGPA">0.00</div>
    <div class="floatHint">Drag to move</div>
  </div>

  <script>
    (function(){
      const gradeOptions = [
        { label: "A+", value: 4.0 },
        { label: "A",  value: 3.75 },
        { label: "B+", value: 3.5 },
        { label: "B",  value: 3.0 },
        { label: "C+", value: 2.5 },
        { label: "C",  value: 2.0 },
        { label: "D+", value: 1.5 },
        { label: "D",  value: 1.0 },
        { label: "F",  value: 0.0 }
      ];
      const creditOptions = [1,2,3,4];

      const MAX_SEMESTERS = 8;
      const DEFAULT_MAX_COURSES = 6;

      const semestersDiv = document.getElementById('semesters');
      const cumulativeEl = document.getElementById('cumulativeGPA');
      const floatCumulativeEl = document.getElementById('floatCumulativeGPA');
      const cumulativeHeader = document.getElementById('cumulativeHeader');
      const resetBtn = document.getElementById('resetBtn');
      const exportBtn = document.getElementById('exportBtn');
      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');
      const floatGPA = document.getElementById('floatGPA');

      // track enabled status per semester (1-based index). Semesters 1-2 always true.
      const enabled = new Array(MAX_SEMESTERS+1).fill(true);
      enabled[1] = true; enabled[2] = true;

      function maxCoursesForSemester(semNum) {
        if (semNum === 1 || semNum === 2) return 2;
        return DEFAULT_MAX_COURSES;
      }
      function minCoursesForSemester(semNum) {
        if (semNum === 1 || semNum === 2) return 2;
        return 0;
      }
      function isRemovableInSemester(semNum) {
        return minCoursesForSemester(semNum) === 0;
      }

      function makeSelectFrom(arr, idPrefix, semNum, courseNum) {
        const sel = document.createElement('select');
        sel.id = `${idPrefix}-${semNum}-${courseNum}`;
        arr.forEach(opt => {
          const o = document.createElement('option');
          if (typeof opt === 'object') { o.value = opt.value; o.textContent = opt.label; }
          else { o.value = opt; o.textContent = opt; }
          sel.appendChild(o);
        });
        sel.addEventListener('change', recalculateAll);
        return sel;
      }

      function createSemesterElement(semNum) {
        const div = document.createElement('div');
        div.className = 'semester';
        div.id = `semester-${semNum}`;

        const title = document.createElement('div');
        title.className = 'semester-title';
        const badgeHTML = (semNum === 1 || semNum === 2)
          ? '<span class="badge">Fixed 2 courses</span>'
          : `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="enable-${semNum}" checked /> Enable</label>`;
        title.innerHTML = `<span>Semester ${semNum}</span>${badgeHTML}`;

        // Hook up enable checkbox for sem >=3
        if (semNum >= 3) {
          const chk = title.querySelector(`#enable-${semNum}`);
          chk.addEventListener('change', () => enableFrom(semNum, chk.checked));
        }

        const courses = document.createElement('div');
        courses.className = 'courses';
        courses.id = `courses-${semNum}`;

        const addCourseBtn = document.createElement('button');
        addCourseBtn.type = 'button';
        addCourseBtn.className = 'small';
        addCourseBtn.textContent = 'Add Course';
        addCourseBtn.id = `addCourseBtn-${semNum}`;
        addCourseBtn.addEventListener('click', () => addCourse(semNum));

        const gpaRow = document.createElement('div');
        gpaRow.className = 'gpa-row';
        gpaRow.innerHTML = `Term GPA: <span id="termGPA-${semNum}">0.00</span>`;

        div.appendChild(title);
        div.appendChild(courses);
        div.appendChild(addCourseBtn);
        div.appendChild(gpaRow);

        return div;
      }

      function enableFrom(semNum, isEnabled) {
        for (let s = semNum; s <= MAX_SEMESTERS; s++) {
          setSemesterEnabled(s, isEnabled);
          const chk = document.getElementById(`enable-${s}`);
          if (chk) chk.checked = isEnabled;
        }
        recalculateAll();
      }

      function setSemesterEnabled(semNum, isEnabled) {
        enabled[semNum] = !!isEnabled;
        const semEl = document.getElementById(`semester-${semNum}`);
        if (!semEl) return;
        if (!isEnabled) semEl.classList.add('disabled'); else semEl.classList.remove('disabled');

        // disable/enable inputs inside semester (but keep header checkbox enabled)
        const selects = Array.from(semEl.querySelectorAll('select'));
        selects.forEach(s => s.disabled = !isEnabled);

        const addBtn = document.getElementById(`addCourseBtn-${semNum}`);
        if (addBtn) addBtn.disabled = !isEnabled;

        // For fixed semesters (1-2) prevent disabling
        if (semNum === 1 || semNum === 2) {
          if (!isEnabled) {
            enabled[semNum] = true;
            semEl.classList.remove('disabled');
            selects.forEach(s => s.disabled = false);
            if (addBtn) addBtn.disabled = false;
          }
        }

        // manage disabled overlay (covering body under the title)
        manageOverlay(semNum, !isEnabled);
      }

      function manageOverlay(semNum, show) {
        const semEl = document.getElementById(`semester-${semNum}`);
        if (!semEl) return;
        let overlay = semEl.querySelector('.disabledOverlay');
        if (show) {
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'disabledOverlay';
            overlay.innerHTML = `
              <div class="disabledOverlayContent" aria-hidden="true">
                <div class="disabledIcon" aria-hidden="true">
                  <!-- circle-slash SVG -->
                  <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                    <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2zm4.95 16.95A8 8 0 1 1 7.05 5.05 8 8 0 0 1 16.95 18.95zM8.46 7.05l8.49 8.49" stroke="none"></path>
                  </svg>
                </div>
                <div>Disabled</div>
              </div>`;
            semEl.appendChild(overlay);
          }
        } else {
          if (overlay) overlay.remove();
        }
      }

      function addCourse(semNum, initialGradeValue, initialCreditValue) {
        if (!enabled[semNum]) return;
        const coursesDiv = document.getElementById(`courses-${semNum}`);
        if (!coursesDiv) return;
        const currentCount = coursesDiv.querySelectorAll('.course').length;
        const maxAllowed = maxCoursesForSemester(semNum);
        if (currentCount >= maxAllowed) return;

        const courseNum = Date.now() + Math.floor(Math.random()*1000);
        const courseDiv = document.createElement('div');
        courseDiv.className = 'course';
        courseDiv.id = `course-${semNum}-${courseNum}`;

        const gradeLabel = document.createElement('label');
        gradeLabel.textContent = 'Grade ';
        const gradeSel = makeSelectFrom(gradeOptions, 'grade', semNum, courseNum);
        if (initialGradeValue !== undefined) gradeSel.value = initialGradeValue;
        gradeLabel.appendChild(gradeSel);

        const creditLabel = document.createElement('label');
        creditLabel.textContent = 'Credits ';
        const creditSel = makeSelectFrom(creditOptions, 'credit', semNum, courseNum);
        if (initialCreditValue !== undefined) creditSel.value = initialCreditValue;
        creditLabel.appendChild(creditSel);

        courseDiv.appendChild(gradeLabel);
        courseDiv.appendChild(creditLabel);

        if (isRemovableInSemester(semNum)) {
          const removeBtn = document.createElement('button');
          removeBtn.type = 'button';
          removeBtn.className = 'small';
          removeBtn.textContent = 'Remove';
          removeBtn.addEventListener('click', () => {
            courseDiv.remove();
            updateAddBtnState(semNum);
            recalculateAll();
          });
          courseDiv.appendChild(removeBtn);
        } else {
          const infoSpan = document.createElement('span');
          infoSpan.style.color = 'var(--muted)';
          infoSpan.style.fontSize = '0.85rem';
          infoSpan.textContent = 'Fixed';
          courseDiv.appendChild(infoSpan);
        }

        coursesDiv.appendChild(courseDiv);
        updateAddBtnState(semNum);
        recalculateAll();
      }

      function updateAddBtnState(semNum) {
        const coursesDiv = document.getElementById(`courses-${semNum}`);
        if (!coursesDiv) return;
        const addBtn = document.getElementById(`addCourseBtn-${semNum}`);
        const currentCount = coursesDiv.querySelectorAll('.course').length;
        const maxAllowed = maxCoursesForSemester(semNum);
        if (addBtn) addBtn.disabled = (!enabled[semNum] || currentCount >= maxAllowed);
      }

      function recalculateAll() {
        let totalPoints = 0, totalCredits = 0;
        for (let s = 1; s <= MAX_SEMESTERS; s++) {
          if (!enabled[s]) {
            const termEl = document.getElementById(`termGPA-${s}`);
            if (termEl) termEl.innerText = '—';
            continue;
          }
          const coursesDiv = document.getElementById(`courses-${s}`);
          if (!coursesDiv) continue;
          const courseDivs = Array.from(coursesDiv.getElementsByClassName('course'));
          let termPoints = 0, termCredits = 0;
          courseDivs.forEach(div => {
            const gradeSel = div.querySelector('select[id^="grade-"]');
            const creditSel = div.querySelector('select[id^="credit-"]');
            if (gradeSel && creditSel) {
              const grade = parseFloat(gradeSel.value || 0);
              const credit = parseInt(creditSel.value || 0, 10);
              if (!isNaN(grade) && !isNaN(credit)) {
                termPoints += grade * credit;
                termCredits += credit;
              }
            }
          });
          const termGPA = termCredits ? (termPoints / termCredits) : 0;
          const termEl = document.getElementById(`termGPA-${s}`);
          if (termEl) termEl.innerText = termGPA ? termGPA.toFixed(2) : '0.00';
          totalPoints += termPoints;
          totalCredits += termCredits;
        }
        const cumulativeGPA = totalCredits ? (totalPoints / totalCredits) : 0;
        if (cumulativeEl) cumulativeEl.innerText = totalCredits ? cumulativeGPA.toFixed(2) : '0.00';
        if (floatCumulativeEl) floatCumulativeEl.innerText = totalCredits ? cumulativeGPA.toFixed(2) : '0.00';
      }

      function buildAllSemesters(prefill=true) {
        semestersDiv.innerHTML = '';
        for (let s = 1; s <= MAX_SEMESTERS; s++) {
          const semEl = createSemesterElement(s);
          semestersDiv.appendChild(semEl);
          enabled[s] = true;
          if (prefill) {
            const toPrefill = Math.max(minCoursesForSemester(s), Math.min(maxCoursesForSemester(s), maxCoursesForSemester(s)));
            for (let c = 0; c < toPrefill; c++) addCourse(s);
          }
          updateAddBtnState(s);
        }
        recalculateAll();
      }

      function resetToDefaults() {
        if (!confirm('Reset all semesters and courses to default configuration?')) return;
        buildAllSemesters(true);
        window.scrollTo({top:0, behavior:'smooth'});
      }

      function exportJSON() {
        const data = { semesters: [] };
        for (let s = 1; s <= MAX_SEMESTERS; s++) {
          const coursesDiv = document.getElementById(`courses-${s}`);
          const courseDivs = coursesDiv ? Array.from(coursesDiv.getElementsByClassName('course')) : [];
          const semData = [];
          courseDivs.forEach(div => {
            const gradeSel = div.querySelector('select[id^="grade-"]');
            const creditSel = div.querySelector('select[id^="credit-"]');
            semData.push({
              gradeValue: gradeSel ? gradeSel.value : null,
              creditValue: creditSel ? creditSel.value : null
            });
          });
          data.semesters.push({
            enabled: !!enabled[s],
            courses: semData
          });
        }
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'gpa-setup.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function importJSONFile(file) {
        const reader = new FileReader();
        reader.onload = function(e){
          try {
            const data = JSON.parse(e.target.result);
            applyImportedData(data);
          } catch(err) {
            alert('Invalid JSON file.');
          }
        };
        reader.readAsText(file);
      }

      function applyImportedData(data){
        if (!data || !Array.isArray(data.semesters)) {
          alert('Invalid format — expected { semesters: [ { enabled, courses: [...] } ] }');
          return;
        }
        semestersDiv.innerHTML = '';
        for (let s = 0; s < MAX_SEMESTERS; s++) {
          const semNum = s+1;
          const semEl = createSemesterElement(semNum);
          semestersDiv.appendChild(semEl);
          const semDataObj = data.semesters[s] || { enabled: true, courses: [] };
          const semData = semDataObj.courses || [];
          const shouldEnable = (semNum === 1 || semNum === 2) ? true : !!semDataObj.enabled;
          enabled[semNum] = !!shouldEnable;
          const toAdd = Math.min(semData.length, maxCoursesForSemester(semNum));
          for (let i=0;i<toAdd;i++){
            const gd = semData[i];
            addCourse(semNum, gd.gradeValue, gd.creditValue);
          }
          const currentCount = document.getElementById(`courses-${semNum}`).querySelectorAll('.course').length;
          const minReq = minCoursesForSemester(semNum);
          for (let k = currentCount; k < minReq; k++) addCourse(semNum);
          setSemesterEnabled(semNum, enabled[semNum]);
          const chk = document.getElementById(`enable-${semNum}`);
          if (chk) chk.checked = !!enabled[semNum];
          updateAddBtnState(semNum);
        }
        for (let s = 3; s <= MAX_SEMESTERS; s++) {
          const chk = document.getElementById(`enable-${s}`);
          if (chk && !chk.checked) {
            enableFrom(s, false);
            break;
          }
        }
        recalculateAll();
      }

      // Hook buttons
      resetBtn.addEventListener('click', resetToDefaults);
      exportBtn.addEventListener('click', exportJSON);
      importBtn.addEventListener('click', () => importFile.click());
      importFile.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (f) importJSONFile(f);
        importFile.value = '';
      });

      // Floating draggable behavior (pointer events)
      (function makeDraggable(el){
        let dragging = false;
        let offsetX = 0, offsetY = 0;

        function onPointerDown(e){
          dragging = true;
          el.setPointerCapture && el.setPointerCapture(e.pointerId);
          const rect = el.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          el.style.transition = 'none';
        }
        function onPointerMove(e){
          if (!dragging) return;
          const x = e.clientX - offsetX;
          const y = e.clientY - offsetY;
          const margin = 8;
          const maxX = window.innerWidth - el.offsetWidth - margin;
          const maxY = window.innerHeight - el.offsetHeight - margin;
          const clampedX = Math.max(margin, Math.min(maxX, x));
          const clampedY = Math.max(margin, Math.min(maxY, y));
          el.style.left = clampedX + 'px';
          el.style.top = clampedY + 'px';
          el.style.right = 'auto';
          el.style.bottom = 'auto';
        }
        function onPointerUp(e){
          dragging = false;
          try { el.releasePointerCapture && el.releasePointerCapture(e.pointerId); } catch(_) {}
          el.style.transition = '';
        }

        el.addEventListener('pointerdown', onPointerDown);
        window.addEventListener('pointermove', onPointerMove);
        window.addEventListener('pointerup', onPointerUp);
      })(floatGPA);

      // IntersectionObserver to show/hide floating GPA only when header cumulative not visible
      (function manageFloatVisibility() {
        if ('IntersectionObserver' in window) {
          const obs = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              const visible = entry.intersectionRatio > 0;
              floatGPA.style.display = visible ? 'none' : 'block';
            });
          }, { root: null, threshold: 0.05 });
          obs.observe(cumulativeHeader);
        } else {
          // fallback: on scroll/resize compute visibility
          function check() {
            const rect = cumulativeHeader.getBoundingClientRect();
            const visible = rect.bottom > 0 && rect.top < window.innerHeight;
            floatGPA.style.display = visible ? 'none' : 'block';
          }
          window.addEventListener('scroll', check, { passive: true });
          window.addEventListener('resize', check);
          check();
        }
      })();

      // Initialize page
      buildAllSemesters(true);

      // expose for debug
      window._gpa = { recalculateAll, addCourse, buildAllSemesters, enableFrom };

    })();
  </script>
</body>
</html>
